#!/usr/bin/env bash
/opt/homebrew/bin/rg --version >/dev/null 2>&1 && export PATH="/opt/homebrew/bin:$PATH"

set -euo pipefail

# Load nvm so Node & pnpm are on PATH (non-interactive shell)
export NVM_DIR="$HOME/.nvm"
# shellcheck disable=SC1090
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
# Use your default or specific version
nvm use --silent 23 || nvm use --silent

# Option A: call pnpm normally (if on PATH)
if command -v pnpm >/dev/null 2>&1; then
  PNPM="pnpm"
else
  # Option B: call pnpm's JS entry to bypass Corepack weirdness
  PNPM_BIN="$(command -v pnpm)"
  PNPM_JS="$(dirname "$PNPM_BIN")/../lib/node_modules/pnpm/bin/pnpm.cjs"
  PNPM="node $PNPM_JS"
fi

echo "ğŸ”’ Pre-push: full security sweep"

# 1) Full-repo secret scan (skips our scanner scripts; masks values)
./tools/scan-secrets.sh

# 2) Gitleaks (if installed) â€” full repo
if command -v gitleaks >/dev/null 2>&1; then
  echo "ğŸ•µï¸ Running gitleaks (full repo)â€¦"
  gitleaks detect --source . --redact --no-banner
else
  echo "gitleaks not installed; skipping. (brew install gitleaks)"
fi

# 3) (Optional) Dependency audit â€“ warn but donâ€™t block push
#    If you want to fail on high/critical, remove '|| true'
echo "ğŸ” pnpm audit (advisory)â€¦"
$PNPM -w audit || true

echo "âœ… Pre-push checks complete."

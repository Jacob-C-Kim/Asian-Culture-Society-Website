name: CI

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: acs
          POSTGRES_PASSWORD: acs
          POSTGRES_DB: acs
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U acs -d acs"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=10

    # CI vars/secrets only (no literals)
    env:
      DATABASE_URL: ${{ vars.CI_DATABASE_URL }}
      NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
      GOOGLE_CLIENT_ID: ${{ vars.CI_GOOGLE_CLIENT_ID }}
      GOOGLE_CLIENT_SECRET: ${{ vars.CI_GOOGLE_CLIENT_SECRET }}
      NEXTAUTH_URL: http://localhost:3000

    steps:
      - uses: actions/checkout@v4

      # Use pnpm from packageManager (pnpm@10.14.0)
      - uses: pnpm/action-setup@v4
        with:
          run_install: false

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - run: corepack enable
      - run: pnpm -v

      # Helpful guard so Prisma never sees an empty URL
      - name: Verify CI env
        run: |
          if [ -z "${DATABASE_URL:-}" ]; then
            echo "::error::CI_DATABASE_URL repository variable is not set."
            echo "Set it in Settings > Secrets and variables > Actions > Variables."
            exit 1
          fi

      - run: pnpm install
      - run: pnpm db:generate
      - run: pnpm db:deploy
      - run: pnpm -C apps/web lint
      - run: pnpm --dir apps/web run typecheck
